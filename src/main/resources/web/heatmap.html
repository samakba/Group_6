<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Heatmap</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <style>
        html, body, #map {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: sans-serif;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: #333;
            z-index: 1000;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .filter-button {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1001;
            background-color: white;
            border: 1px solid #ccc;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .filter-button:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
<div id="loading" class="loading">Loading map...</div>
<button class="filter-button" onclick="filterHeatmap()">Filter</button>
<div id="map"></div>

<script>
    let map;
    let heatLayer;
    let originalPoints = [];
    let mapReady = false;

    console.log("Initializing Leaflet map");

    function hideLoading() {
        const loading = document.getElementById('loading');
        if (loading) loading.style.display = 'none';
    }

    function initializeMap() {
        try {
            map = L.map('map', {
                center: [43.6532, -79.3832],
                zoom: 12,
                zoomControl: true,
                attributionControl: true
            });

            const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 18
            });

            tileLayer.on('load', () => {
                console.log("Tiles loaded");
                hideLoading();
                mapReady = true;
            });

            tileLayer.on('tileerror', e => console.log("Tile error:", e));
            tileLayer.addTo(map);

            setTimeout(() => {
                hideLoading();
                mapReady = true;
                console.log("Map initialized (fallback)");
            }, 3000);

        } catch (error) {
            console.log("Error initializing map:", error.message);
            document.getElementById('loading').innerHTML = 'Error loading map: ' + error.message;
        }
    }

    function updateHeatmap(jsonPoints) {
        console.log("updateHeatmap called with:", jsonPoints);

        if (!mapReady || !map) {
            console.log("Map not ready, retrying...");
            setTimeout(() => updateHeatmap(jsonPoints), 1000);
            return;
        }

        try {
            const points = JSON.parse(jsonPoints);
            originalPoints = points; // Save for filtering later
            drawHeatLayer(points);
        } catch (error) {
            console.log("ERROR in updateHeatmap:", error.message);
        }
    }

    function drawHeatLayer(points) {
        if (heatLayer) map.removeLayer(heatLayer);

        const heatData = points.map(p => [
            p.lat,
            p.lng,
            Math.max(0.1, Math.min(1.0, (p.weight || 0.5)))
        ]);

        heatLayer = L.heatLayer(heatData, {
            radius: 25,
            blur: 15,
            maxZoom: 17,
            max: 1.0,
            minOpacity: 0.4,
            gradient: {
                0.0: 'blue',
                0.2: 'cyan',
                0.4: 'lime',
                0.6: 'yellow',
                0.8: 'orange',
                1.0: 'red'
            }
        }).addTo(map);

        if (points.length > 0) {
            const group = new L.featureGroup(
                points.map(p => L.marker([p.lat, p.lng]))
            );
            map.fitBounds(group.getBounds().pad(0.1));
        }
    }

    function filterHeatmap() {
        if (!originalPoints.length) return;

        // Example filter: only include points with weight >= 0.7
        const filtered = originalPoints.filter(p => (p.weight || 0.5) >= 0.7);
        console.log(`Filtered from ${originalPoints.length} to ${filtered.length} points`);
        drawHeatLayer(filtered);
    }

    // Example usage:
    const sampleData = JSON.stringify([
        { lat: 43.65, lng: -79.38, weight: 0.3 },
        { lat: 43.66, lng: -79.39, weight: 0.9 },
        { lat: 43.64, lng: -79.37, weight: 0.7 },
        { lat: 43.67, lng: -79.4, weight: 0.2 }
    ]);

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            initializeMap();
            setTimeout(() => updateHeatmap(sampleData), 1000); // mock loading
        });
    } else {
        initializeMap();
        setTimeout(() => updateHeatmap(sampleData), 1000); // mock loading
    }

</script>
</body>
</html>
