<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Heatmap</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <style>
        html, body, #map {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: sans-serif;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: #333;
            z-index: 1000;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">Loading map...</div>
    <div id="map"></div>

    <script>
        let map;
        let heatLayer;
        let mapReady = false;

        console.log("Initializing Leaflet map");

        function hideLoading() {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.style.display = 'none';
            }
        }

        function initializeMap() {
            try {
                // Initialize the map
                map = L.map('map', {
                    center: [43.6532, -79.3832], // Toronto
                    zoom: 12,
                    zoomControl: true,
                    attributionControl: true
                });

                // Add OpenStreetMap tiles with error handling
                const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors',
                    maxZoom: 18,
                    tileSize: 256,
                    zoomOffset: 0
                });

                tileLayer.on('loading', function() {
                    console.log("Tiles are loading...");
                });

                tileLayer.on('load', function() {
                    console.log("Tiles loaded successfully");
                    hideLoading();
                    mapReady = true;
                });

                tileLayer.on('tileerror', function(e) {
                    console.log("Tile error:", e);
                });

                tileLayer.addTo(map);

                // Fallback to hide loading after timeout
                setTimeout(() => {
                    hideLoading();
                    mapReady = true;
                    console.log("Map initialized (fallback)");
                }, 3000);

                console.log("Leaflet map initialized successfully");

            } catch (error) {
                console.log("Error initializing map:", error.message);
                document.getElementById('loading').innerHTML = 'Error loading map: ' + error.message;
            }
        }

        function updateHeatmap(jsonPoints) {
            console.log("updateHeatmap called with:", jsonPoints);

            if (!mapReady || !map) {
                console.log("Map not ready, retrying...");
                setTimeout(() => updateHeatmap(jsonPoints), 1000);
                return;
            }

            try {
                const points = JSON.parse(jsonPoints);
                console.log("Parsed " + points.length + " points");

                if (points.length === 0) {
                    console.log("No points to display");
                    return;
                }

                // Remove existing heat layer
                if (heatLayer) {
                    map.removeLayer(heatLayer);
                }

                // Convert points to Leaflet heat format [lat, lng, intensity]
                const heatData = points.map(p => [
                    p.lat, 
                    p.lng, 
                    Math.max(0.1, Math.min(1.0, (p.weight || 0.5)))
                ]);

                // Create heat layer with better visibility
                heatLayer = L.heatLayer(heatData, {
                    radius: 25,
                    blur: 15,
                    maxZoom: 17,
                    max: 1.0,
                    minOpacity: 0.4,
                    gradient: {
                        0.0: 'blue',
                        0.2: 'cyan',
                        0.4: 'lime',
                        0.6: 'yellow',
                        0.8: 'orange',
                        1.0: 'red'
                    }
                }).addTo(map);

                console.log("Heatmap updated with " + points.length + " points");

                // Fit map to show all points with padding
                if (points.length > 0) {
                    const group = new L.featureGroup(
                        points.map(p => L.marker([p.lat, p.lng]))
                    );
                    map.fitBounds(group.getBounds().pad(0.1));
                }

            } catch (error) {
                console.log("ERROR in updateHeatmap:", error.message);
            }
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeMap);
        } else {
            initializeMap();
        }

        console.log("Leaflet heatmap script ready");
    </script>
</body>
</html>